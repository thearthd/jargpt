<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>JAR GPT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#343541;
      --surface:#444654;
      --user:#1e88e5;
      --bot:#343541;
      --text:#d1d5db;
      --subtle:#9ca3af;
      --accent:#2b7cff;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    header{
      background:var(--surface);
      padding:12px 20px;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    header h1{font-size:18px;font-weight:600;margin:0;}
    .limits{display:flex;gap:20px;font-size:13px;color:var(--subtle);}
    .limits span{color:#fff;font-weight:600;}

    #chat{
      flex:1;
      overflow-y:auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .msg{
      display:flex;
      gap:12px;
      max-width:740px;
      margin:0 auto;
      width:100%;
    }
    .msg.user{flex-direction:row-reverse;}
    .bubble{
      padding:14px 18px;
      border-radius:18px;
      white-space:pre-wrap;
      line-height:1.55;
      position:relative;
    }
    .msg.user .bubble{background:var(--user);}
    .msg.bot  .bubble{background:var(--bot);}
    .avatar{
      width:32px;height:32px;border-radius:50%;
      background:var(--surface);
      display:grid;place-items:center;font-size:18px;
    }
    code{
      background:rgba(0,0,0,.35);
      padding:2px 4px;border-radius:4px;font-size:85%;
    }
    pre{
      background:#1e1e1e;
      padding:14px 16px;border-radius:8px;overflow-x:auto;
      position:relative;
    }
    pre code{background:none;padding:0;}
    .copy{
      position:absolute;top:6px;right:6px;
      background:rgba(255,255,255,.12);color:#fff;
      border:none;border-radius:4px;padding:4px 8px;
      font-size:12px;cursor:pointer;
    }
    .copy:hover{background:rgba(255,255,255,.2);}
    .thinking{
      display:flex;gap:6px;align-items:center;
      color:var(--subtle);font-size:14px;padding:14px 0;
    }
    .thinking span{width:8px;height:8px;border-radius:50%;background:var(--subtle);animation:bounce 1.2s infinite;}
    .thinking span:nth-child(2){animation-delay:.2s;}
    .thinking span:nth-child(3){animation-delay:.4s;}
    @keyframes bounce{0%,80%,100%{transform:scale(0);}40%{transform:scale(1);}}

    #inputArea{
      background:var(--surface);
      border-top:1px solid rgba(255,255,255,.1);
      padding:16px 20px;
      display:flex;gap:12px;align-items:flex-end;
    }
    #inputArea textarea{
      flex:1;
      background:var(--bg);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:12px 16px;
      color:var(--text);
      resize:none;
      max-height:120px;
      font-size:16px;
      line-height:1.45;
      font-family:inherit;
    }
    #inputArea button{
      background:var(--accent);
      color:#fff;border:none;border-radius:8px;
      padding:12px 20px;font-size:15px;font-weight:600;
      cursor:pointer;
    }
    #inputArea button:disabled{opacity:.45;cursor:not-allowed;}
    .hint{color:var(--subtle);font-size:12px;margin-top:6px;text-align:center;}
  </style>
</head>
<body>
  <header>
    <h1>JAR GPT</h1>
    <div class="limits">
      <div>RPM: <span id="rpm">â€” / 15</span></div>
      <div>RPD: <span id="rpd">â€” / 200</span></div>
    </div>
  </header>

  <main id="chat"></main>

  <form id="inputArea">
    <textarea id="prompt" rows="1" placeholder="Message JAR GPTâ€¦"></textarea>
    <button id="sendBtn">Send</button>
  </form>

  <script type="importmap">{"imports":{"@google/generative-ai":"https://esm.run/@google/generative-ai"}}</script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script type="module">
  import {GoogleGenerativeAI} from "https://esm.run/@google/generative-ai";

  // Load API key from localStorage, or ask user to input it
  let API_KEY = localStorage.getItem("JAR_GPT_API_KEY") || "";
  if (!API_KEY) {
    API_KEY = prompt("Enter your Google Generative AI API key:");
    if (API_KEY) {
      localStorage.setItem("JAR_GPT_API_KEY", API_KEY);
    } else {
      alert("No API key provided. JAR GPT will not work.");
    }
  }

  const genAI = new GoogleGenerativeAI(API_KEY);

  const firebaseConfig = {
    apiKey:"AIzaSyApsou3Oe3GVBBHevhDEKLvGN0qAIBVPKU",
    authDomain:"jargpt-29ae0.firebaseapp.com",
    databaseURL:"https://jargpt-29ae0-default-rtdb.firebaseio.com",
    projectId:"jargpt-29ae0",
    storageBucket:"jargpt-29ae0.firebasestorage.app",
    messagingSenderId:"869559466658",
    appId:"1:869559466658:web:69c74443cee135ff7ff5fb"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const pad=n=>String(n).padStart(2,'0');
  function minuteKey(d=new Date()){return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+pad(d.getHours())+pad(d.getMinutes());}
  function dayKey(d=new Date()){return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate());}

  async function increment(path,d=1){return db.ref(path).transaction(v=>(v||0)+d);}
  async function readValue(path){const s=await db.ref(path).get();return s.exists()?s.val():0;}

  async function refreshCounters(){
    const m=minuteKey(),d=dayKey();
    const rpm=await readValue(`/usage/requests/byMinute/${m}`);
    const rpd=await readValue(`/usage/requests/byDay/${d}`);
    rpmEl.textContent=`${rpm} / 15`;
    rpdEl.textContent=`${rpd} / 200`;
  }
  setInterval(refreshCounters,5000);refreshCounters();

  const chat=document.getElementById('chat');
  const promptEl=document.getElementById('prompt');
  const sendBtn=document.getElementById('sendBtn');
  const rpmEl=document.getElementById('rpm');
  const rpdEl=document.getElementById('rpd');

  function addBubble(content,isUser){
    const wrap=document.createElement('div');
    wrap.className='msg '+(isUser?'user':'bot');
    wrap.innerHTML=`
      <div class="avatar">${isUser?'ðŸ‘¤':'ðŸ¤–'}</div>
      <div class="bubble">${content}</div>`;
    chat.appendChild(wrap);
    wrap.scrollIntoView({behavior:'smooth'});
    return wrap.querySelector('.bubble');
  }
  function addThinking(){
    const wrap=document.createElement('div');
    wrap.className='msg bot';
    wrap.innerHTML=`
      <div class="avatar">ðŸ¤–</div>
      <div class="thinking">
        <span></span><span></span><span></span>
      </div>`;
    chat.appendChild(wrap);
    wrap.scrollIntoView({behavior:'smooth'});
    return wrap;
  }

  async function send(){
    const text=promptEl.value.trim();
    if(!text)return;
    addBubble(text,true);
    promptEl.value='';
    sendBtn.disabled=true;

    const think=addThinking();

    const mk=minuteKey(),dk=dayKey();
    try{
      await increment(`/usage/requests/byMinute/${mk}`,1);
      await increment(`/usage/requests/byDay/${dk}`,1);
    }catch(e){console.error(e)}

    try{
      const model=genAI.getGenerativeModel({model:'gemini-2.0-flash'});
      const result=await model.generateContent(text);
      const reply=await result.response.text();
      think.remove();
      const bubble=addBubble('',false);
      bubble.innerHTML=renderMarkdown(reply);
      addCopyButtons(bubble);
    }catch(err){
      think.remove();
      addBubble('Error: '+err.message,false);
    }
    sendBtn.disabled=false;
    refreshCounters();
  }

  document.getElementById('inputArea').addEventListener('submit',e=>{e.preventDefault();send();});
  promptEl.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}
  });

  function renderMarkdown(src){
    return src
      .replace(/```(\w+)?\n([\s\S]*?)```/g,(m,lang,code)=>
        `<pre><code class="language-${lang||''}">${escapeHtml(code.trim())}</code><button class="copy">Copy</button></pre>`)
      .replace(/`([^`]+)`/g,'<code>$1</code>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>');
  }
  function escapeHtml(str){
    return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function addCopyButtons(parent){
    parent.querySelectorAll('pre').forEach(pre=>{
      const btn=pre.querySelector('.copy');
      btn.onclick=()=>{
        navigator.clipboard.writeText(pre.querySelector('code').textContent);
        btn.textContent='Copied!';
        setTimeout(()=>btn.textContent='Copy',1200);
      };
    });
  }
</script>

</body>
</html>
